---
title: "Regression Cautions"
subtitle: "Stat 230: Applied Regression Analysis"
format: 
  revealjs:
    theme: [serif, styles.scss]
    scrollable: true
editor: source
editor_options: 
  chunk_output_type: console
code-annotations: hover
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(echo = TRUE, dev = 'svg', comment = NULL)

library(ggformula)
library(dplyr)
library(broom)
library(gridExtra)
library(effects)
library(ggthemes)
library(forcats)
library(here)
library(gt)
library(gtsummary)

options(digits=4) # display four significant digits by default

theme_classic <- function() {
  ggplot2::theme_classic() +
    ggplot2::theme(
      plot.background = ggplot2::element_rect(fill = "#fffef5", color = NA),
      panel.background = ggplot2::element_rect(fill = "#fffef5", color = NA),
      axis.line = ggplot2::element_line(color = "#003069"),
      axis.text = ggplot2::element_text(color = "#003069"),
      axis.ticks = ggplot2::element_line(color = "#003069"),
      axis.title = ggplot2::element_text(color = "#003069")
    )
}

graph_paper <- ggplot(data = data.frame(x = 0:20, y = 0:20), aes(x, y)) +
  theme_classic() +
  scale_x_continuous(name = "Age", breaks = seq(0, 20, by = 2), expand = c(0, 0)) +
  scale_y_continuous(name = "FEV", breaks = seq(0, 20, by = 2), expand = c(0, 0)) +
  theme(  
    panel.grid.major = element_line(color = "gray60", size = 0.5), # Major grid lines
    panel.grid.minor = element_line(color = "gray60", size = 0.25), # Minor grid lines
  )

# set ggplot2 theme
ggplot2::theme_set(theme_classic())


ex1 <- read.table("https://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%207%20Data%20Sets/CH07TA06.txt")
colnames(ex1) <- c("x1", "x2", "y")

ex2 <- read.table("https://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%207%20Data%20Sets/CH07TA08.txt")
colnames(ex2) <- c("x1", "x2", "y")

bodyfat <- read.table("https://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%207%20Data%20Sets/CH07TA01.txt")
colnames(bodyfat) <- c("triceps_skinfold", "thigh_circumference", "midarm_circumference", "body_fat")
```

# Multicollinearity

Situation where 2+ predictors are "nearly" perfectly correlated


## Think about it

- Work through Examples 1-3 on worksheet

- Work with your group to complete the tasks

- Let me know when finish Task 6

- Be prepared to share thoughts with the class


## Diagnosing multicollinearity 

:::{.incremental}
- Examine scatterplot matrix

- Examine pairwise correlations between predictors

- Look for $\widehat{\beta}_i$s with unusual signs

- Notice sensitivity to changes in the model/order of predictors

- Calculate the **Variance Inflation Factor (VIF)**
:::


## Variance Inflation Factor (VIF)


${\rm VIF} = \dfrac{1}{1 - R^2_i}$

$R^2_i=R^2$ from model predicting $x_i$ using all other predictor variables

. . .

Guidelines:

- $\text{VIF}_i > 5$ suspicions begin; $R^2_i > .8$
- $\text{VIF}_i > 10$ indicates a problem; $R^2_i > .9$
- $\text{VIF}_i > 100$ indicates a big problem; $R^2_i > .99$


## VIFs for Example 1

```{r}
#| eval: false
ex1_mod <- lm(y ~ x1 + x2, data = ex1)
car::vif(ex1_mod)
```

<br>

```{r}
#| echo: false
ex1_mod <- lm(y ~ x1 + x2, data = ex1)
car::vif(ex1_mod) |>
  as.data.frame() %>%
  mutate(Variable = rownames(.)) %>%
  rename(VIF = `car::vif(ex1_mod)`) |>
  relocate(Variable) |>
  gt() |>
  tab_options(
    table.font.size = px(28),
    table.background.color = "#fffef5",
    table.font.color = "#003069"
  )
```


:::{.footer}
The `vif()` command is in the `car` R package
:::


## VIFs for Example 2


`car::vif()` throws an error! Why?

. . .

$\text{VIF} = \dfrac{1}{1 - R^2_i}$

:::{.incremental}
- Since $x_1$ and $x_2$ are perfectly correlated, $R^2_i = 1$

- This makes the denominator $1 - R^2_i = 0$

- So, $\text{VIF} = \dfrac{1}{0}$ is undefined
:::

## VIFs for Example 3

```{r}
#| eval: false
bodyfat_mod <- lm(body_fat ~ ., data = bodyfat)
car::vif(bodyfat_mod)
```

<br>


```{r}
#| echo: false
bodyfat_mod <- lm(body_fat ~ ., data = bodyfat)
car::vif(bodyfat_mod) |>
  as.data.frame() %>%
  mutate(Variable = rownames(.)) %>%
  rename(VIF = `car::vif(bodyfat_mod)`) |>
  relocate(Variable) |>
  gt() |>
    tab_options(
    table.font.size = px(28),
    table.background.color = "#fffef5",
    table.font.color = "#003069"
  )
```

:::{.footer}
The `.` on the right side of the model formula tells R to use all other variables in the data frame as predictors
:::


## Remedial measures {.smaller}

:::{.incremental}
- Use the model only for prediction, if you think future observations will have the same relationships amongst variables

- For polynomials, use `poly(x, degree)` in R, or center the variable

- Drop some of highly correlated variables â€” USE CAUTION, doesn't always work and loses information

- Add cases that  break the correlation between predictors -- reasonable in designed experiments

- Create composite variables (e.g., sums, averages, principal components) -- can be harder to interpret

- Use ridge regression or LASSO -- need Stat 270 (Statistical Learning)

:::

## The problem with R<sup>2</sup> {.smaller}

Different polynomial models were used to predict the horizontal distance based on the starting point in Galileo's experimental data

<br>


| Order | R<sup>2</sup> |
|-------|---------|
| 1 | 0.9264 |
| 2 | 0.9903 |
| 3 | 0.9994 | 
| 4 | 0.9998 |
| 5 | 0.99996 |
| 6 | 1.0000 |

## Adjusted R<sup>2</sup> 

Imposes a **penalty for model complexity**, so it increases only if the improvement outweighs the cost of making the model more complex

$$
R^2_{\text{adj}} = 1 - \left( \frac{n-1}{n-p-1} \right)  \cdot \left(1 - R^2 \right)
$$


## Adjusted R<sup>2</sup> 

| Order | R<sup>2</sup> | R<sup>2</sup><sub>adj</sub> |
|-------|---------|-------|
| 1 | 0.9264  | 0.9116 | 
| 2 | 0.9903  | 0.9855 | 
| 3 | 0.9994  | 0.9988 | 
| 4 | 0.9998  | 0.9995 | 
| 5 | 0.99996 | 0.9998 | 
| 6 | 1.0000  | undefined | 

:::{.footer}
Recall that there are only n = 7 observations in this data set
:::