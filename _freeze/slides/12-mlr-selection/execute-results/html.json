{
  "hash": "369dcc8929fe388c6947a722b208796b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Model Selection\"\nsubtitle: \"Stat 230: Applied Regression Analysis\"\nformat: \n  revealjs:\n    theme: [serif, styles.scss]\n    scrollable: true\neditor: source\neditor_options: \n  chunk_output_type: console\ncode-annotations: hover\n---\n\n\n\n# Visualizing a fitted model\n\nHow can we create a useful 2-dimensional picture of the relationship between $Y$ and $x_i$, after accounting for the other variables in the model?\n\n## The problem with scatterplots\n\n\n:::{.columns}\n::: {.column width=\"65%\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-1-1.svg){fig-align='center' width=90%}\n:::\n:::\n\n\n:::\n\n::: {.column width=\"35%\"}\n<br>\n\nWe only see the marginal relationships between pairs of variables, not the relationships after accounting for other variables\n:::\n:::\n\n\n## Partial residual plots\n\nConsider two-predictor model: $\\widehat{y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 x_1 + \\widehat{\\beta}_2 x_2$\n\n<br>\n\nTo isolate the relationship between $Y$ and $x_2$ after accounting for $x_1$, we can:\n\n1. Fit the MLR model\n\n2. Calculate the residuals from the fitted model: $e_i = y_i - \\widehat{y}_i$\n\n3. Add the \"contribution\" of $x_j$ back into residuals: $\\text{pres}_{j,i} = e_i + \\widehat{\\beta}_jx_{j,i}$\n\n4. Plot $\\text{pres}_j$ against $x_j$\n\n\n## Example\n\nAfter accounting for climb, what is the relationship between time and distance?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-2-1.svg){fig-align='center' width=432}\n:::\n:::\n\n\n\n## Example\n\nAfter accounting for distance, what is the relationship between time and climb?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-3-1.svg){fig-align='center' width=432}\n:::\n:::\n\n\n## Why is this useful?\n\n- We can see the “effect” of $x_j$ after adjusting for other model terms\n\n- We can see the variation in $y$ that remains after adjusting for other model terms\n\n- We can look for outliers that could be affecting the estimated effect of $x_j$\n\n- We can see if the effect of $x_j$ is correctly modeled, **non-linearity** and/or non-constant variance suggest we need to correct our model form\n\n\n## Partial residual plots in R\n\nThe `car` package calls them **component + residual plots**\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(car)\nmod <- lm(time ~ dist + climb, data = hills2000)\ncrPlots(mod, layout = c(1, 2))\n```\n\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-4-1.svg){fig-align='center' width=960}\n:::\n:::\n\n\n:::{.footer}\nNote: The partial residuals in these plots are centered\n:::\n\n\n## Example 1\n\n:::{.columns}\n::: {.column width=\"30%\"}\nTrue model\n\nFitted model\n\n:::\n::: {.column width=\"50%\"}\n$y = x_1^2 + 0.5x_2 + \\epsilon$\n\n$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\epsilon$\n:::\n:::\n\nBoth $x_1$ and $x_2$ are numeric, roughly between -5 and 5\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-6-1.svg){width=672}\n:::\n:::\n\n\n\n\n## Example 2\n\n\n:::{.columns}\n::: {.column width=\"30%\"}\nTrue model\n\nFitted model\n\n:::\n::: {.column width=\"50%\"}\n$y = x_1^2 + 0.5x_2 + \\epsilon$\n\n$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\epsilon$\n:::\n:::\n\nBut now $x_1$ is strictly positive $\\rightarrow$ monotone relationship\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-7-1.svg){width=672}\n:::\n:::\n\n\n## Example 1\n\n:::{.columns}\n::: {.column width=\"30%\"}\nTrue model\n\nFitted model\n\n:::\n::: {.column width=\"50%\"}\n$y = x_1^2 + 0.5x_2 + \\epsilon$\n\n$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\epsilon$\n:::\n:::\n\nBoth $x_1$ and $x_2$ are numeric, roughly between -5 and 5\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-8-1.svg){fig-align='center' width=624}\n:::\n:::\n\n\n## Example 2\n\n\n:::{.columns}\n::: {.column width=\"30%\"}\nTrue model\n\nFitted model\n\n:::\n::: {.column width=\"50%\"}\n$y = x_1^2 + 0.5x_2 + \\epsilon$\n\n$y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\epsilon$\n:::\n:::\n\nBut now $x_1$ is strictly positive $\\rightarrow$ monotone relationship\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-9-1.svg){fig-align='center' width=624}\n:::\n:::\n\n\n\n## Your turn\n\n- Work through example on the handout\n\n- Be ready to share your thoughts (I'm going to cold call)\n\n\n\n## Effects plots\n\nConsider two-predictor model: $\\widehat{y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 x_1 + \\widehat{\\beta}_2 x_2$\n\n<br>\n\n1. Fix $x_1$ at some value, say $x_1 = c$\n\n2. Calculate $\\widehat{y}$ for a range of $x_2$ values: $\\widehat{y} = \\widehat{\\beta}_0 + \\widehat{\\beta}_1 c + \\widehat{\\beta}_2 x_2$\n\n3. Plot $\\widehat{y}$ against $x_2$ \n\n\n## Example\n\nWhats the relationship between record time and distance, holding the total climb constant?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-10-1.svg){fig-align='center' width=336}\n:::\n:::\n\n\n:::{.footer}\nClimb held constant at its mean value, 2077.32 ft\n:::\n\n\n---\n## Example\n\nWhats the relationship between record time and the total climb, holding the distance constant?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-11-1.svg){fig-align='center' width=336}\n:::\n:::\n\n\n\n:::{.footer}\nDistance held constant at its mean value, 7.53 miles\n:::\n\n## Effects plots in R\n\nThe `ggeffects` package provides a nice way to visualize fitted models\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggeffects)\nmod <- lm(time ~ dist + climb, data = hills2000)\npredict_response(mod, terms = \"dist\") |> \n  plot() +\n  labs(\n    y = \"My y-axis label\",\n    x = \"My x-axis label\"\n  )\n```\n:::\n\n\n. . .\n\n<br>\n\n:::{.callout-note}\nIt holds the other predictors at their mean (for numeric) or mode (for categorical)\n:::\n\n\n## Plotting interaction models\n\nRecall the FEV model with interaction between age and smoking status:\n\n$\\mu(y|x) = \\beta_0 + \\beta_1 \\mathtt{smoker} + \\beta_2 \\mathtt{age} + \\beta_3 \\mathtt{age} \\times \\mathtt{smoker}$\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](12-mlr-selection_files/figure-revealjs/unnamed-chunk-13-1.svg){fig-align='center' width=432}\n:::\n:::\n\n\n\n## Effects plots in R\n\n\n:::{.callout-note}\nTo get multiple fitted lines representing different groups, specify the variable you want to plot and the grouping variable in the `terms` argument\n:::\n\n<br>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfev_lm <- lm(FEV ~ Age * Smoke, data = fev)\npredict_response(fev_lm, terms = c(\"Age\", \"Smoke\")) |>\n  plot()\n```\n:::\n\n\n\n## Your turn\n\n- Work through example on the handout\n\n- Be ready to share your thoughts (I'm going to cold call)\n\n\n\n# Model building\n\n## 1. Define the goal\n\nBefore you start building a model you need to identify why you are building the model. \n\n* Exploring associations\n\n* Testing a theoretical relationship\n\n* Controlling for confounders\n\n* Prediction\n\n\n:::{.footer}\nReasons can be intertwined\n:::\n\n\n## 2. Choose an initial pool of predictors\n\n\n- Theory might dictate some/all variables\n\n- Designed experiment might dictate some/all variables\n\n- In other situations\n\n    + Examine variables one at a time -- beware of skew, note outliers\n    + Examine pairwise correlations/scatterplot matrix -- note potential predictors, multicollinearity\n\n    \n## 3. Fit a full regression model\n\nFit a \"full\" initial regression model where you include all of the potential variables\n\n\n## 4. Question your full model\n\n- Check the full model for violations to the conditions, fix as needed.\n\n- Order I check/fix:\n\n    1.  Linearity\n    2.  Heteroscedasticity\n    3.  Normality\n    4.  Outliers and influential points \n\n\n## 5. Examine if any variables can be dropped/added\n\n- There may be \"insignificant\" predictor variables that you can consider dropping\n\n- You could use t-tests or extra-sums-of-squares F-tests to guide these decisions\n\n- You could use model selection criteria (AIC, BIC, adjusted R<sup>2</sup>) to guide these decisions\n\n- Sometimes you discover reasons to add variables (e.g., remedy model deficiencies, discovery of interactions)\n\n## \n\n### 6. Iterate through steps 4 and 5\n\n- Modeling is an iterative process, unlikely to find the \"best\" model on the first try\n- Each time you change the model, you need to re-check/fix the model conditions\n\n### 7. Do a final model check\n\n- Are the conditions are satisfied?\n- Outliers and influential points?\n- Multicollinearity?\n\n## 8. Proceed with your analysis\n\n- Interpret coefficients\n- Test hypotheses\n- Make predictions\n\n:::{.callout-note}\n## Confirming a theory\n\nWhen you want to confirm a theory, only include \"extra\" predictors in the model building process.\n\nAdd the variables that are \"predetermined\" by the theory back into the model at the end of the model building process.\n\n:::\n\n\n\n## SAT data\n\n:::{style=\"font-size: 0.85em;\"}\n\nData for the 50 states\n\nVariable | Description\n---------|----------------------------\n`sat`  | average of combined verbal and math SAT\n`takers` | percentage of eligible seniors who took exam\n`income`  | median income of families of test-takers\n`years` | mean number of years of schooling\n`public`   | percentage of test-takers attending public school\n`expend` | total state expenditure on secondary schools (in hundreds of dollars per student)\n`rank`   | median percentile rank of test-takers in their high school classes\n\n:::\n\n:::{.footer}\n`case0901` in the Sleuth\n:::\n\n## Working for the legislature\n\n:::{style=\"font-size: 0.85em;\"}\nWhat is the impact of state expenditures on SAT scores after accounting for other factors?\n:::\n\n. . .\n\n:::{style=\"font-size: 0.85em;\"}\n**Strategy**: First, choose controls, then add expenditures\n:::\n\n. . .\n\n:::{style=\"font-size: 0.75em;\"}\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 144.5300 </td>\n   <td style=\"text-align:right;\"> 297.1628 </td>\n   <td style=\"text-align:right;\"> 0.4864 </td>\n   <td style=\"text-align:right;\"> 0.6291 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rank </td>\n   <td style=\"text-align:right;\"> 4.4498 </td>\n   <td style=\"text-align:right;\"> 2.7466 </td>\n   <td style=\"text-align:right;\"> 1.6201 </td>\n   <td style=\"text-align:right;\"> 0.1124 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Income </td>\n   <td style=\"text-align:right;\"> 0.2054 </td>\n   <td style=\"text-align:right;\"> 0.1162 </td>\n   <td style=\"text-align:right;\"> 1.7672 </td>\n   <td style=\"text-align:right;\"> 0.0841 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Years </td>\n   <td style=\"text-align:right;\"> 24.8751 </td>\n   <td style=\"text-align:right;\"> 6.4223 </td>\n   <td style=\"text-align:right;\"> 3.8732 </td>\n   <td style=\"text-align:right;\"> 0.0004 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> log(Takers) </td>\n   <td style=\"text-align:right;\"> -26.0915 </td>\n   <td style=\"text-align:right;\"> 17.0035 </td>\n   <td style=\"text-align:right;\"> -1.5345 </td>\n   <td style=\"text-align:right;\"> 0.1321 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Public </td>\n   <td style=\"text-align:right;\"> 0.6962 </td>\n   <td style=\"text-align:right;\"> 0.5513 </td>\n   <td style=\"text-align:right;\"> 1.2630 </td>\n   <td style=\"text-align:right;\"> 0.2132 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n\n. . . \n\n:::{style=\"font-size: 0.85em;\"}\n- `Rank`, `log(Takers)`, and `Public` may not be significant - but can we trust these results?\n:::\n\n## Our model is overspecified!\n\n`Rank` and `log(Takers)` are highly correlated!\n\n:::{style=\"font-size: 1.2em;\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nvif(political_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       Rank      Income       Years log(Takers)      Public \n     21.068       1.692       1.326      22.175       1.928 \n```\n\n\n:::\n:::\n\n:::\n\n<br>\n\nLet's try dropping `Rank` and refitting the model...\n\n\n## Model B\n\nIt looks like `Public` can also be removed as it doesn't explain a substantial proportion of the variability in `SAT` scores\n\n<br>\n\n:::{style=\"font-size: 0.9em;\"}\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> -268.779 </td>\n   <td style=\"text-align:right;\"> 127.4007 </td>\n   <td style=\"text-align:right;\"> -2.1097 </td>\n   <td style=\"text-align:right;\"> 0.0405 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rank </td>\n   <td style=\"text-align:right;\"> 8.509 </td>\n   <td style=\"text-align:right;\"> 0.7496 </td>\n   <td style=\"text-align:right;\"> 11.3522 </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Income </td>\n   <td style=\"text-align:right;\"> 0.230 </td>\n   <td style=\"text-align:right;\"> 0.1168 </td>\n   <td style=\"text-align:right;\"> 1.9689 </td>\n   <td style=\"text-align:right;\"> 0.0551 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Years </td>\n   <td style=\"text-align:right;\"> 27.564 </td>\n   <td style=\"text-align:right;\"> 6.2710 </td>\n   <td style=\"text-align:right;\"> 4.3954 </td>\n   <td style=\"text-align:right;\"> 0.0001 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Public </td>\n   <td style=\"text-align:right;\"> 0.267 </td>\n   <td style=\"text-align:right;\"> 0.4821 </td>\n   <td style=\"text-align:right;\"> 0.5539 </td>\n   <td style=\"text-align:right;\"> 0.5824 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n:::\n\n\n\n## Now, add expenditure\n\nExamine the significance of expenditure after controlling for rank, income and years.\n\n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> term </th>\n   <th style=\"text-align:right;\"> estimate </th>\n   <th style=\"text-align:right;\"> std.error </th>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> -285.4613 </td>\n   <td style=\"text-align:right;\"> 98.9617 </td>\n   <td style=\"text-align:right;\"> -2.885 </td>\n   <td style=\"text-align:right;\"> 0.0060 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Rank </td>\n   <td style=\"text-align:right;\"> 9.3411 </td>\n   <td style=\"text-align:right;\"> 0.7393 </td>\n   <td style=\"text-align:right;\"> 12.636 </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Income </td>\n   <td style=\"text-align:right;\"> 0.1199 </td>\n   <td style=\"text-align:right;\"> 0.1078 </td>\n   <td style=\"text-align:right;\"> 1.112 </td>\n   <td style=\"text-align:right;\"> 0.2719 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Years </td>\n   <td style=\"text-align:right;\"> 25.5321 </td>\n   <td style=\"text-align:right;\"> 5.3994 </td>\n   <td style=\"text-align:right;\"> 4.729 </td>\n   <td style=\"text-align:right;\"> 0.0000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Expend </td>\n   <td style=\"text-align:right;\"> 1.6162 </td>\n   <td style=\"text-align:right;\"> 0.6706 </td>\n   <td style=\"text-align:right;\"> 2.410 </td>\n   <td style=\"text-align:right;\"> 0.0201 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n",
    "supporting": [
      "12-mlr-selection_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}