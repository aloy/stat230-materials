---
title: "Regression Diagnostics"
webr:
  packages:
    - car
    - ggResidpanel
    - broom
    - ggformula
format: 
  live-html:
    toc: true
editor: source
editor_options: 
  chunk_output_type: console
execute:
  eval: false
---

{{< include ../_extensions/r-wasm/live/_knitr.qmd >}}

```{r}
#| include: false
#| eval: true
# surgical_data <- read.csv("data/surgical_example_data.csv")
```


## Overview

In this activity you will learn how to calculate diagnostic measures and create diagnostic plots for multiple linear regression models in R. 



## Model overview

A hospital surgical unit was interested in predicting the survival in patients undergoing a particular type of liver operation. A random selection of 108 patients was selected for analysis. For each patient, the following information was extracted from the pre-operation evaluation and used by the research team to predict survival time (in days):

- `blood_clot_score`: a score based on blood clotting tests
- `prognostic_index`: a prognostic index based on various health factors
- `enzyme_test`: a score based on liver enzyme tests
- `alchohol_use_heavy`: an indicator variable for heavy alcohol use (1 = heavy use, 0 = not heavy use)

The research team determined that the following multiple regression model is a reasonable starting point:

$$
\text{survival time} = \beta_0 + \beta_1(\text{blood clot score}) + \beta_2(\text{prognostic index}) + \beta_3(\text{enzyme test}) + \beta_4(\text{heavy alcohol use}) + \epsilon
$$

This model is fit using the below code:

```{r}
surgical_lm <- lm(survival_time ~ blood_clot_score + prognostic_index + enzyme_test + alchohol_use_heavy, data = surgical_data)
```


## Residual analysis in R

When we have multiple predictors, we can still use residual plots to assess the assumptions of the linear regression model. You can still use the `resid_panel(model, type = "standardized")` function in the `ggResidpanel` package to create a panel of residual plots that includes a plot of the residuals vs. fitted values, a histogram of the residuals, and a Q-Q plot of the residuals. 

```{webr}
library(ggResidpanel)
resid_panel(surgical_lm, type = "standardized")
```



To get plots of the standardized residuals against the individual predictors, I recommend using the `residualPlots()` command in the `car` package. Below is the code to create these plots for the surgical data example.

```{webr}
library(car)
residualPlots(surgical_lm, type = "rstandard", tests = FALSE, quadratic = FALSE, layout = c(2, 3))
```

Key arguments to the `residualPlots()` function include:

- `model`: the linear model object created using the `lm()` function
- `type = "rstandard"`: specifies that we want to plot the standardized residuals
- `tests = FALSE`: removes the automatic addition of significance tests for non-linearity
- `quadratic = FALSE`: removes a quadratic smoother on the residual plot
- `layout = c(2, 3)`: specifies the layout of the plots (2 rows and 3 columns), which is useful for organizing multiple plots in a single view

**Question:** Based on the residual plots, do you think the current multiple linear regression model is appropriate for this data? Why or why not?

**Question:** Regardless of your answer, apply a log transformation to the response variable and refit the model using the code below. Then, create the same residual plots for the new model. Do you think the log transformation improved the model fit? Why or why not?

```{webr}
log_surgical_lm <- lm(log(survival_time) ~ blood_clot_score + prognostic_index + enzyme_test + alchohol_use_heavy, data = surgical_data)

# Put your residual plot code here
```


## Influence analysis

Let's continue working with the log-transformed model. We can use the `influenceIndexPlot()` function in the `car` package to create influence plots for the log-transformed model. Each plot will display one of the diagnostic measures and plot it against the row number (index). Below is the code to create these plots for the surgical data example.

```{webr}
influenceIndexPlot(log_surgical_lm, vars = c("hat", "student", "Cook"))
```

Key arguments to the `influenceIndexPlot()` function include:

- `model`: the linear model object created using the `lm()` function
- `vars = c("hat", "student", "Cook", )`: specifies which influence measures to plot. In this case, we are plotting Cook's distance, leverage (hat values), and studentized (standardized) residuals

**Question:** What observations (row numbers) are identified as possibly influential in each of the three plots? 

**Question:** Do you think any of these observations are truly influential? Why or why not? It may be useful to look back through your notes to review the definitions of these influence measures and the suggested cutoffs.



## Alternative R implementation for influence measures

While the use of the `influenceIndexPlot()` function is a quick way to visualize influence measures, it does not provide the actual values of these measures. To obtain the actual values, we can use the `augment()` function in the `broom` R package. Below is the code to obtain these measures for the log-transformed model.

```{webr}
library(broom)
log_surgical_lm_aug <- augment(log_surgical_lm)
head(log_surgical_lm_aug)
```

The `augment()` function adds several columns to the original data frame, including:

- `.fitted`: the fitted values from the model
- `.resid`: the residuals from the model
- `.std.resid`: the standardized residuals from the model
- `.hat`: the leverage (hat values) from the model
- `.cooksd`: Cook's distance from the model


***

## Function quick reference
| Function                  | Package        | Description                                                                                   |
|:--------------------------|:---------------|:----------------------------------------------------------------------------------------------|
| `resid_panel()`           | `ggResidpanel` | Creates a panel of residual plots for a linear model                                                     |
| `residualPlots()`         | `car`          | Creates residual plots for each predictor in a linear model                                                |
| `influenceIndexPlot()`    | `car`          | Creates influence plots for a linear model                                                        |
| `augment()`               | `broom`        | Adds columns to a data frame with information about a model fit, including residuals and influence measures |