---
title: "Inference for Logistic Regression"
format: html
engine: knitr
editor: source
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
#| eval: true
p <- 0

framingham <- read.csv("https://aloy.github.io/stat230-materials/data/framingham.csv")
```


## Overview

In this activity you will continue exploring logistic regression models for the Framingham Heart Study data set.

Recall that the Framingham Heart Study is a long-term study of cardiovascular disease (heart attack, stroke, and other heart problems) that began in 1948. The study identified the idea that body measurements (blood pressure, cholesterol, etc) could predict cardiovascular disease. In this activity we will explore an expanded set of predictor variables to model whether a participant experienced coronary heart disease (CHD) in a 10-year window after their exam. The variables we will consider include:
 
- `age`: age of participant (in years)
- `currentSmoker`: indicator for whether participant is a current smoker (1 = yes, 0 = no)
- `totChol`: total cholesterol (mg/dL)
- `sysBP`: systolic blood pressure (mm Hg)
- `BMI`: body mass index (weight in kg / (height in m)$^2$)


## Confidence intervals

Suppose that you have decided to fit a logistic regression model with `age`, `currentSmoker`, `totChol`, `sysBP`, and `BMI` as predictors. Below is the coefficient table from the `glm()` output for this model.

```{r}
#| echo: false
framingham_glm <- glm(TenYearCHD ~ age + currentSmoker + totChol + sysBP + BMI,
                      data = framingham,
                      family = binomial)
broom::tidy(framingham_glm) |>
  dplyr::mutate(p.value = gtsummary::style_pvalue(p.value)) |>
  gt::gt() |>
  gt::fmt_number(
    columns = c(estimate, std.error, statistic),
    decimals = 3
  )
```

**Task 1.** Calculate a 90% confidence interval for the coefficient of `BMI`. 


::: {.callout-tip collapse="true"}
### Solution

To calculate a 90% Wald-based confidence interval for the coefficient of `BMI`, we can use the formula:

$$\hat{\beta}_5 \pm z_{\alpha/2} \cdot SE(\hat{\beta}_5)$$  

From the output table, we have:
- $\hat{\beta}_5 = 0.017$
- $SE(\hat{\beta}_5) = 0.011$

For a 90% confidence interval, the critical value $z^*_{0.95}$ is the 0.95 quantile from a standard normal distribution. This can be found using the `qnorm()` function in R:

```{r}
qnorm(0.95)
```

Thus, the confidence interval is:

$$0.017 \pm 1.645 \cdot 0.011 = (-0.001095, 0.035095)$$

Remember that **this CI is on the log odds scale**.


:::

**Task 2.** Interpret your confidence interval in context. Use a change of 5 kg/m$^2$ in BMI for your interpretation.

:::{.callout-tip collapse="true"}
### Solution

To interpret the confidence interval for the coefficient of `BMI` based on a 5-unit change rather than a one-unit change, we can multiply the endpoints of the confidence interval by 5:

$$(5 \times -0.001095, 5 \times 0.035095) = (-0.005475,  0.175475)$$

Then, we can exponentiate these values to convert them from the log-odds scale to the odds ratio scale:

$$\left(e^{-0.005475}, e^{0.175475}\right) = (0.9945, 1.1918)$$

We are 90% confident that a 5 kg/m$^2$ increase in BMI is associated with a change in the  odds of experiencing coronary heart disease in a 10-year window by a factor between 0.9945 and 1.1918, holding all other factors constant. Since this interval includes 1, it suggests that there may be no significant effect of BMI on the odds of coronary heart disease at the 90% confidence level.

:::


**Task 3.** Calculate a 90% confidence interval for the coefficient of `currentSmoker`. 

::: {.callout-tip collapse="true"}
### Solution

We again use the formula for a Wald-based confidence interval:

$$0.545 \pm 1.645 \cdot 0.096 = (0.38708, 0.70292)$$
Remember that **this CI is on the log odds scale**.
:::



**Task 4.** Interpret this confidence interval in context.

:::{.callout-tip collapse="true"}
### Solution

Exponentiating the endpoints of the confidence interval gives us:

$$(e^{0.38708}, e^{0.70292}) = (1.4727, 2.0196)$$
We are 90% confident that being a current smoker is associated with an increase in the odds of experiencing coronary heart disease in a 10-year window by a factor between 1.4727 and 2.0196 compared to the odds for a non-smoker with the same total cholesterol, systolic blood pressure, and BMI.


:::

## Drop-in deviance tests

If you are "star gazing" at the previous output, you may notice that two predictors are statistically significant at the 0.05 level. 


**Task 5.** Use a drop-in deviance test to determine whether we can drop `totChol` and `BMI` from our logistic regression model. 


a. State the null and alternative hypotheses for this test.

:::{.callout-tip collapse="true"}
### Solution

$H_0: \beta_3 = \beta_5 = 0$ (The coefficients for `totChol` and `BMI` are both zero, meaning they do not contribute to the model.)

$H_a$: At least one of $\beta_3$ or $\beta_5$ is not equal to zero

:::


b. Calculate the test statistic for this test. Below are snippets from the output from both models, which you need for this calculation.

Full model:
```
    Null deviance: 3524.3  on 4171  degrees of freedom
Residual deviance: 3203.3  on 4166  degrees of freedom
```

```{r}
#| include: false
framingham_aug <- broom::augment(framingham_glm)
framingham_glm_reduced <- glm(TenYearCHD ~ age + currentSmoker + sysBP,
                              data = framingham_aug,
                              family = binomial)
```


Reduced model:

```
    Null deviance: 3524.3  on 4171  degrees of freedom
Residual deviance: 3207.1  on 4168  degrees of freedom
```

:::{.callout-tip collapse="true"}
### Solution
The test statistic for a drop-in deviance test is calculated as the difference in residual deviance between the reduced and full models:

$$
\begin{split}
\text{LRT} &= \text{deviance(reduced model)} - \text{deviance(full model)}\\
&= 3207.1 - 3203.3\\
&= 3.8
\end{split}
$$

:::

c. Calculate the p-value for this test.

:::{.callout-tip}
## `pchisq()`
You can use the `pchisq()` function in R to calculate areas under a chi-square distribution. For example, to calculate the area to the right of 5.99 under a chi-square distribution with 2 degrees of freedom, you would use the following code:

```{r}
1 - pchisq(5.99, df = 2)
```
:::


:::{.callout-tip collapse="true"}
### Solution
The degrees of freedom for this test is equal to the difference in the number of predictors between the full and reduced models; thus, df = 2. 

The p-value can be calculated using the chi-square distribution. Specifically, we want to find the the tail area to the right of our test statistic (3.8) with 2 degrees of freedom.

In R, we can use the `pchisq()` function to calculate this area:

```{r}
1 - pchisq(3.8, df = 2)
```

Our p-value is approximately 0.15.

:::



d. State your conclusion in the context of the problem. You may use a significance level of 0.05.

:::{.callout-tip collapse="true"}
### Solution

Since our p-value is greater than 0.05, we fail to reject the null hypothesis. There is no evidence to suggest that at least one of the coefficients for `totChol` or `BMI` is not equal to zero. Therefore, we can drop these predictors from our logistic regression model.

:::



**Task 6.** What model do you think is being described by the `Null deviance` line of the output above? (Hint: think about what "null" means in this context, it's similar to our extra-sums-of-squares F-test.)


:::{.callout-tip collapse="true"}
### Solution

The `Null deviance` corresponds to a model that only includes the intercept (no predictors). This model predicts the same probability of experiencing coronary heart disease for all participants, regardless of their individual characteristics.
:::



